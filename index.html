<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />
  <meta name="googlebot" content="noindex, nofollow" />
  <title>Aplikasi Bendahara Umum</title>
  <style>
    /* Reset & Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-color: #2c3e50;
      --secondary-color: #27ae60;
      --danger-color: #e74c3c;
      --success-color: #27ae60;
      --bg-color: #f4f6f9;
      --card-bg: #ecf0f1;
      --text-dark: #2c3e50;
      --text-light: #666;
      --border-color: #ccc;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 10px;
      --transition: all 0.3s ease;
    }

    html {
      height: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      color: var(--primary-color);
      padding: 15px 20px;
      border: 10px solid var(--primary-color);
      margin-bottom: 20px;
      position: relative;
      z-index: 100;
    }

    header > div {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: nowrap;
      justify-content: center;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    header img {
      height: 80px;
      width: auto;
      max-width: 120px;
      object-fit: contain;
      border-radius: 5px;
      flex-shrink: 0;
    }

    header .header-text {
      flex: 1;
      min-width: 0;
      text-align: center;
      padding: 0 10px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      text-align: center;
      word-wrap: break-word;
    }

    header p {
      margin: 5px 0 0 0;
      font-size: 14px;
      text-align: center;
      word-wrap: break-word;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
    }

    /* Typography */
    h2 {
      margin-top: 35px;
      margin-bottom: 18px;
      color: var(--primary-color);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    h2:first-of-type {
      margin-top: 0;
    }

    h3 {
      margin-top: 25px;
      margin-bottom: 12px;
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 600;
    }

    .muted {
      color: var(--text-light);
      font-size: 13px;
      margin-top: 10px;
    }

    /* Forms */
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    form input,
    form select {
      padding: 12px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      flex: 1;
      min-width: 150px;
      background: white;
      transition: var(--transition);
    }

    form input:hover,
    form select:hover {
      border-color: var(--secondary-color);
    }

    form button {
      padding: 10px 20px;
      font-size: 14px;
      background: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      transition: var(--transition);
      white-space: nowrap;
    }

    form button:hover {
      background: #219150;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Tables */
    .table-wrapper {
      overflow-x: auto;
      margin: 15px 0;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 600px;
      background: white;
    }

    th,
    td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background: #34495e;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }

    tr:hover {
      background: #f0f0f0;
    }

    /* Table inputs */
    input[type="number"] {
      width: 100px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--secondary-color);
      transform: scale(1.1);
    }

    input[type="checkbox"]:checked {
      accent-color: var(--secondary-color);
    }

    /* Buttons */
    .delete-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: var(--transition);
    }

    .delete-btn:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }

    /* Summary Cards */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .card h3 {
      font-size: 14px;
      margin: 0 0 10px 0;
      color: var(--text-dark);
    }

    .card p {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
      margin: 0;
    }

    /* Rekap Bulanan */
    #rekap-bulanan {
      margin-top: 20px;
    }

    #rekap-bulanan table {
      margin-bottom: 20px;
    }

    /* Editable Name */
    td[style*="cursor: pointer"] {
      cursor: pointer;
      color: #0066cc;
      text-decoration: underline;
      transition: var(--transition);
    }

    td[style*="cursor: pointer"]:hover {
      color: #0052a3;
    }

    /* Section Header with Button */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }

    .section-header h2 {
      margin: 0;
      flex: 1;
      min-width: 250px;
    }

    /* Export Button */
    #export-excel-btn {
      padding: 12px 24px;
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: var(--transition);
      white-space: nowrap;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #export-excel-btn:hover {
      background: #219150;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    #export-excel-btn:active {
      transform: translateY(0);
    }

    /* Better Table Styling */
    table {
      font-size: 13px;
    }

    thead th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      padding: 12px 8px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tbody td {
      padding: 10px 8px;
      vertical-align: middle;
    }

    /* Form Improvements */
    form input:focus,
    form select:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
    }

    /* Card Improvements */
    .card {
      border: 1px solid var(--border-color);
      background: white;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
      position: relative;
      z-index: 1;
    }

    .card p {
      font-size: 20px;
      font-weight: 700;
      margin-top: 8px;
      position: relative;
      z-index: 1;
    }

    /* Mobile Responsive */
    @media screen and (max-width: 768px) {
      body {
        position: fixed;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      header {
        padding: 12px 10px;
        border-width: 5px;
        margin-bottom: 10px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 1000;
      }

      header > div {
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }

      header img {
        height: 50px;
        max-width: 80px;
        flex-shrink: 0;
      }

      header img:first-of-type {
        order: 1;
      }

      header .header-text {
        flex-basis: 100%;
        order: 2;
        width: 100%;
        padding: 0 5px;
      }

      header img:last-of-type {
        order: 3;
        display: none; /* Sembunyikan logo kedua di mobile untuk lebih rapi */
      }

      header h1 {
        font-size: 16px;
        line-height: 1.3;
      }

      header p {
        font-size: 11px;
        line-height: 1.3;
      }

      .container {
        margin: 0;
        padding: 15px;
        border-radius: 0;
        margin-top: 100px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }

      h2 {
        font-size: 18px;
        margin-top: 20px;
        margin-bottom: 12px;
      }

      h3 {
        font-size: 16px;
      }

      form {
        flex-direction: column;
      }

      form input,
      form select,
      form button {
        width: 100%;
        min-width: unset;
      }

      .summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .card {
        padding: 12px;
      }

      .card h3 {
        font-size: 12px;
      }

      .card p {
        font-size: 16px;
      }

      table {
        font-size: 11px;
        min-width: 500px;
      }

      th,
      td {
        padding: 6px 4px;
      }

      .table-wrapper {
        margin: 10px 0;
        border-left: none;
        border-right: none;
        border-radius: 0;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        overflow-x: auto;
      }

      /* Prevent horizontal overflow for images */
      img:not(header img) {
        max-width: 100%;
        height: auto;
      }

      .delete-btn {
        padding: 5px 10px;
        font-size: 11px;
      }

      /* Section header mobile */
      .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .section-header h2 {
        font-size: 18px;
      }

      /* Export button mobile */
      #export-excel-btn {
        width: 100%;
        justify-content: center;
        font-size: 13px;
        padding: 12px;
      }
    }

    @media screen and (max-width: 480px) {
      header {
        padding: 10px 8px;
        border-width: 4px;
      }

      header > div {
        gap: 6px;
      }

      header img {
        height: 45px;
        max-width: 70px;
      }

      header img:last-of-type {
        display: none; /* Tetap sembunyikan logo kedua di mobile kecil */
      }

      header h1 {
        font-size: 14px;
        line-height: 1.2;
      }

      header p {
        font-size: 10px;
        line-height: 1.2;
      }

      .container {
        margin-top: 95px;
        max-height: calc(100vh - 95px);
        padding: 12px;
      }

      h2 {
        font-size: 16px;
      }

      .summary {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 10px;
        min-width: 500px;
      }

      th,
      td {
        padding: 4px 2px;
      }

      .card p {
        font-size: 14px;
      }
    }

    /* Print Styles */
    @media print {
      header {
        border: 2px solid var(--primary-color);
        page-break-after: avoid;
      }

      form {
        display: none;
      }

      .delete-btn {
        display: none;
      }
    }

    /* Loading State */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Smooth Scrolling */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <script>
    // Password Protection
    var password = prompt("Masukkan password untuk mengakses:");
    if (password !== "Chabendum25") {
      alert("Password salah! Akses ditolak.");
      window.location.href = "https://google.com";
    }

    // Source Code Obfuscation - Menyembunyikan source code dari tab Sources
    // Dev tools tetap bisa dibuka untuk debugging mobile
    (function() {
      'use strict';
      
      // Disable Ctrl+U (View Source) - hanya ini yang di-disable agar source tidak mudah dilihat
      document.addEventListener('keydown', function(e) {
        if (e.key === 'u' && e.ctrlKey) {
          e.preventDefault();
          return false;
        }
      }, false);

      // Disable right-click context menu pada elemen tertentu untuk mengurangi inspect element
      // Tapi tidak terlalu agresif agar tidak mengganggu UX
      document.addEventListener('contextmenu', function(e) {
        // Hanya disable jika klik pada elemen tertentu, tidak semua
        if (e.target.tagName === 'SCRIPT' || e.target.tagName === 'STYLE') {
          e.preventDefault();
          return false;
        }
      }, false);
    })();
  </script>

  <header>
    <div>
      <img src="LogoUin.png" alt="Logo UIN" />
      <div class="header-text">
        <h1>Kerjaan Bendahara Umum</h1>
        <p>Kelola Pemasukan, Pengeluaran, Peminjaman, Anggaran & Kas Mingguan HMPS SI 2025</p>
      </div>
      <img src="LogoSi.png" alt="Logo HMPS SI" />
    </div>
  </header>

  <div class="container">
    <!-- Form Tambah Transaksi -->
    <h2>Tambah Transaksi</h2>
    <form id="transaction-form">
      <input type="text" id="deskripsi" placeholder="Deskripsi" required />
      <input type="number" id="jumlah" placeholder="Jumlah (Rp)" required />
      <select id="kategori">
        <option value="pemasukan">Pemasukan</option>
        <option value="pengeluaran">Pengeluaran</option>
        <option value="peminjaman">Peminjaman</option>
      </select>
      <input type="date" id="tanggal" required />
      <select id="bulan-transaksi">
        <option value="Januari">Januari</option>
        <option value="Februari">Februari</option>
        <option value="Maret">Maret</option>
        <option value="April">April</option>
        <option value="Mei">Mei</option>
        <option value="Juni">Juni</option>
        <option value="Juli">Juli</option>
        <option value="Agustus">Agustus</option>
        <option value="September">September</option>
        <option value="Oktober">Oktober</option>
        <option value="November">November</option>
        <option value="Desember">Desember</option>
      </select>
      <button type="submit">Tambah</button>
    </form>

    <!-- Riwayat Transaksi -->
    <h2>Riwayat Transaksi</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Bulan</th>
            <th>Tanggal</th>
            <th>Deskripsi</th>
            <th>Kategori</th>
            <th>Jumlah (Rp)</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="transaction-list"></tbody>
      </table>
    </div>

    <!-- Summary Cards -->
    <div class="summary">
      <div class="card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: 2px solid #11998e;">
        <h3 style="color: rgba(255,255,255,0.9);">Total Pemasukan</h3>
        <p id="total-pemasukan" style="color: white;">Rp 0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; border: 2px solid #eb3349;">
        <h3 style="color: rgba(255,255,255,0.9);">Total Pengeluaran</h3>
        <p id="total-pengeluaran" style="color: white;">Rp 0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: 2px solid #f093fb;">
        <h3 style="color: rgba(255,255,255,0.9);">Total Peminjaman</h3>
        <p id="total-peminjaman" style="color: white;">Rp 0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: 2px solid #4facfe;">
        <h3 style="color: rgba(255,255,255,0.9);">Saldo Akhir</h3>
        <p id="saldo-akhir" style="color: white;">Rp 0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: 2px solid #43e97b;">
        <h3 style="color: rgba(255,255,255,0.9);">Saldo Uang Kas</h3>
        <p id="saldo-uang-kas" style="color: white;">Rp 0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;">
        <h3 style="color: rgba(255,255,255,0.9);">Total Saldo Sekarang</h3>
        <p id="total-saldo-sekarang" style="color: white;">Rp 0</p>
      </div>
    </div>

    <!-- Rekap Bulanan -->
    <h2>Rekap Bulanan (Januari - Desember)</h2>
    <div id="rekap-bulanan"></div>

    <!-- Pembayaran Uang Kas Mingguan -->
    <div class="section-header">
      <h2>Pembayaran Uang Kas Mingguan</h2>
      <button id="export-excel-btn">
        <span>ðŸ“¥</span>
        <span>Export ke Excel</span>
      </button>
    </div>
    <p class="muted" style="margin-top: -15px; margin-bottom: 15px;">38 Orang, April - Desember 2025</p>
    <div class="table-wrapper">
      <table>
        <thead id="kas-header"></thead>
        <tbody id="kas-list"></tbody>
      </table>
    </div>

    <!-- Form Tambah Pemakaian Kas -->
    <h3>Tambah Pemakaian Kas</h3>
    <form id="kas-usage-form">
      <input type="date" id="kas-tanggal" required />
      <input type="text" id="kas-deskripsi" placeholder="Deskripsi" required />
      <input type="number" id="kas-jumlah" placeholder="Jumlah (Rp)" required />
      <button type="submit">Tambah Pemakaian</button>
    </form>

    <!-- Riwayat Uang Kas -->
    <h3>Riwayat Uang Kas</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Jenis</th>
            <th>Deskripsi</th>
            <th>Jumlah (Rp)</th>
            <th>Saldo Kas</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="riwayat-kas"></tbody>
      </table>
    </div>
    <p class="muted">Catatan: total per minggu di-set Rp 1.000, Ubah sesuai kebutuhan.</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      deleteDoc,
      doc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBwU3TJ_9TfNT1wBs6taFsGtfGJ0iRyAFc",
      authDomain: "cha-project-f8997.firebaseapp.com",
      projectId: "cha-project-f8997",
      storageBucket: "cha-project-f8997.appspot.com",
      messagingSenderId: "1002188011351",
      appId: "1:1002188011351:web:0611d96d68071caa62b012",
      measurementId: "G-QN4S9EZB05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Constants
    const sabtu2025 = {
      "April": [5, 12, 19, 26],
      "Mei": [3, 10, 17, 24, 31],
      "Juni": [7, 14, 21, 28],
      "Juli": [5, 12, 19, 26],
      "Agustus": [2, 9, 16, 23, 30],
      "September": [6, 13, 20, 27],
      "Oktober": [4, 11, 18, 25],
      "November": [1, 8, 15, 22, 29],
      "Desember": [6, 13, 20, 27]
    };

    const totalWeeks = Object.values(sabtu2025).flat().length;
    const PAYMENT_PER_WEEK = 1000;

    const defaultKas = Array.from({ length: 38 }, (_, i) => ({
      nama: `Anggota ${i + 1}`,
      minggu: Array(totalWeeks).fill(false)
    }));

    // Firebase CRUD Functions
    async function tambahTransaksiFirebase(transaksi) {
      try {
        const data = { ...transaksi, createdAt: new Date().toISOString() };
        const docRef = await addDoc(collection(db, "transactions"), data);
        return docRef.id;
      } catch (err) {
        console.error("tambahTransaksiFirebase:", err);
        throw err;
      }
    }

    async function loadTransaksiFirebase() {
      try {
        const q = query(collection(db, "transactions"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        return snapshot.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            deskripsi: data.deskripsi || '',
            jumlah: (typeof data.jumlah === 'string') ? parseFloat(data.jumlah) : (data.jumlah || 0),
            kategori: data.kategori || '',
            bulan: data.bulan || '',
            tanggal: data.tanggal || '',
            createdAt: data.createdAt || ''
          };
        });
      } catch (err) {
        console.error("loadTransaksiFirebase:", err);
        return [];
      }
    }

    async function hapusTransaksiFirebase(id) {
      try {
        await deleteDoc(doc(db, "transactions", id));
      } catch (err) {
        console.error("hapusTransaksiFirebase:", err);
        throw err;
      }
    }

    async function loadKasFirebase() {
      try {
        const q = query(collection(db, "kas2025"), orderBy("nomor", "asc"));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          return [];
        }
        return snapshot.docs.map((d, index) => {
          const data = d.data() || {};
          const mingguArr = Array.isArray(data.minggu)
            ? data.minggu.map(v => !!v)
            : Array(totalWeeks).fill(false);

          return {
            id: d.id,
            nomor: data.nomor || (index + 1),
            nama: data.nama || `Anggota ${index + 1}`,
            minggu: mingguArr,
            totalBayar: typeof data.totalBayar === "number"
              ? data.totalBayar
              : mingguArr.filter(Boolean).length * PAYMENT_PER_WEEK
          };
        });
      } catch (err) {
        console.error("loadKasFirebase:", err);
        return [];
      }
    }

    async function updateKasFirebase(id, minggu, nama, nomor) {
      try {
        const mingguFix = Array.isArray(minggu) ? minggu.map(v => !!v) : Array(totalWeeks).fill(false);
        const totalBayar = mingguFix.filter(Boolean).length * PAYMENT_PER_WEEK;
        await setDoc(doc(db, "kas2025", id), {
          minggu: mingguFix,
          totalBayar,
          nama,
          nomor
        });
        console.log("updateKasFirebase: updated", id, { minggu: mingguFix, totalBayar, nama, nomor });
      } catch (err) {
        console.error("updateKasFirebase gagal:", err);
        throw err;
      }
    }

    async function updateNamaKasFirebase(id, nama) {
      try {
        await setDoc(doc(db, "kas2025", id), { nama }, { merge: true });
      } catch (err) {
        console.error("updateNamaKasFirebase:", err);
        throw err;
      }
    }

    async function tambahRiwayatKasFirebase(kas) {
      try {
        const docRef = await addDoc(collection(db, "riwayatKas"), {
          ...kas,
          createdAt: new Date().toISOString()
        });
        return docRef.id;
      } catch (err) {
        console.error("tambahRiwayatKasFirebase:", err);
        throw err;
      }
    }

    async function loadRiwayatKasFirebase() {
      try {
        const q = query(collection(db, "riwayatKas"), orderBy("createdAt", "asc"));
        const snapshot = await getDocs(q);
        return snapshot.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            tanggal: data.tanggal || '',
            deskripsi: data.deskripsi || '',
            jumlah: (typeof data.jumlah === 'string') ? parseFloat(data.jumlah) : (data.jumlah || 0),
            createdAt: data.createdAt || ''
          };
        });
      } catch (err) {
        console.error("loadRiwayatKasFirebase:", err);
        return [];
      }
    }

    async function hapusRiwayatKasFirebase(id) {
      try {
        await deleteDoc(doc(db, "riwayatKas", id));
      } catch (err) {
        console.error("hapusRiwayatKasFirebase:", err);
        throw err;
      }
    }

    // DOM Elements
    const transactionForm = document.getElementById('transaction-form');
    const transactionList = document.getElementById('transaction-list');
    const totalPemasukan = document.getElementById('total-pemasukan');
    const totalPengeluaran = document.getElementById('total-pengeluaran');
    const totalPeminjaman = document.getElementById('total-peminjaman');
    const saldoAkhir = document.getElementById('saldo-akhir');
    const saldoUangKas = document.getElementById('saldo-uang-kas');
    const totalSaldoSekarang = document.getElementById('total-saldo-sekarang');
    const kasHeader = document.getElementById('kas-header');
    const kasList = document.getElementById('kas-list');
    const kasUsageForm = document.getElementById('kas-usage-form');
    const riwayatKas = document.getElementById('riwayat-kas');

    // App State
    let transactions = [];
    let kasData = [];
    let kasUsage = [];

    // Utility Functions
    function getTotalKas() {
      let total = 0;
      kasData.forEach(a => {
        if (Array.isArray(a.minggu)) {
          a.minggu.forEach(p => { if (p) total += PAYMENT_PER_WEEK; });
        }
      });
      return total;
    }

    function getSaldoAkhirKas() {
      let totalKas = getTotalKas();
      let totalPemakaian = 0;
      if (kasUsage && kasUsage.length > 0) {
        kasUsage.forEach(u => {
          totalPemakaian += Number(u.jumlah) || 0;
        });
      }
      return totalKas - totalPemakaian;
    }

    // Hitung saldo akhir berdasarkan urutan transaksi (running balance)
    function getSaldoAkhirDariTransaksi() {
      if (!transactions || transactions.length === 0) {
        return 0;
      }

      // Urutkan transaksi berdasarkan bulan dan tanggal
      const bulanUrutan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
      
      const sortedTransactions = [...transactions].sort((a, b) => {
        const bulanA = bulanUrutan.indexOf(a.bulan || '');
        const bulanB = bulanUrutan.indexOf(b.bulan || '');
        if (bulanA !== bulanB) {
          return bulanA - bulanB;
        }
        // Jika bulan sama, urutkan berdasarkan tanggal
        return new Date(a.tanggal || '1970-01-01') - new Date(b.tanggal || '1970-01-01');
      });

      // Hitung running balance
      let saldo = 0;
      sortedTransactions.forEach(t => {
        const jumlahNum = Number(t.jumlah) || 0;
        if (t.kategori === 'pemasukan') {
          saldo += jumlahNum;
        } else if (t.kategori === 'pengeluaran') {
          saldo -= jumlahNum;
        } else if (t.kategori === 'peminjaman') {
          saldo -= jumlahNum;
        }
      });

      return saldo;
    }

    // Export to Excel Function
    function exportToExcel() {
      try {
        if (!kasData || kasData.length === 0) {
          alert('Data pembayaran kas masih kosong. Silakan isi data terlebih dahulu.');
          return;
        }

        // Buat array untuk header minggu
        let weekHeaders = ['No', 'Nama'];
        
        // Generate header untuk setiap minggu
        Object.keys(sabtu2025).forEach(bulan => {
          sabtu2025[bulan].forEach(tgl => {
            weekHeaders.push(`${bulan} ${tgl}`);
          });
        });
        
        weekHeaders.push('Jumlah Minggu Bayar', 'Total Bayar (Rp)', 'Status', 'Catatan');

        // Buat data rows
        let csvContent = '\uFEFF'; // BOM untuk UTF-8 (agar Excel membaca dengan benar)
        csvContent += weekHeaders.join(';') + '\n';

        kasData.forEach((anggota, idx) => {
          const nomor = anggota.nomor || (idx + 1);
          const nama = anggota.nama || `Anggota ${idx + 1}`;
          const mingguArr = Array.isArray(anggota.minggu) ? anggota.minggu : Array(totalWeeks).fill(false);
          
          let row = [nomor, nama];
          
          // Status pembayaran per minggu - menggunakan centang seperti di web
          mingguArr.forEach(paid => {
            row.push(paid ? 'âœ“' : ''); // âœ“ untuk sudah bayar, kosong untuk belum bayar
          });
          
          // Hitung jumlah minggu yang sudah bayar
          const jumlahMingguBayar = mingguArr.filter(Boolean).length;
          const totalBayar = jumlahMingguBayar * PAYMENT_PER_WEEK;
          
          row.push(jumlahMingguBayar);
          row.push(totalBayar);
          
          // Status
          const persentaseBayar = ((jumlahMingguBayar / totalWeeks) * 100).toFixed(1);
          if (jumlahMingguBayar === 0) {
            row.push('Belum Bayar');
            row.push('Belum ada pembayaran');
          } else if (jumlahMingguBayar === totalWeeks) {
            row.push('Lunas');
            row.push('Sudah lunas semua');
          } else {
            row.push(`Belum Lunas (${persentaseBayar}%)`);
            row.push(`Masih kurang ${totalWeeks - jumlahMingguBayar} minggu`);
          }
          
          // Gabungkan dengan delimiter ; (Excel lebih baik dengan ; untuk Indonesia)
          csvContent += row.map(cell => {
            // Escape cell jika mengandung ; atau "
            if (typeof cell === 'string' && (cell.includes(';') || cell.includes('"'))) {
              return '"' + cell.replace(/"/g, '""') + '"';
            }
            return cell;
          }).join(';') + '\n';
        });

        // Buat dan download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const today = new Date();
        const dateStr = today.getFullYear() + 
          String(today.getMonth() + 1).padStart(2, '0') + 
          String(today.getDate()).padStart(2, '0');
        
        link.setAttribute('href', url);
        link.setAttribute('download', `Data_Pembayaran_Kas_${dateStr}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Buat juga file khusus yang belum bayar
        exportBelumBayarExcel();
        
        alert('Data berhasil diekspor ke Excel! File CSV sudah didownload dan bisa dibuka di Excel.');
      } catch (err) {
        console.error('Error export Excel:', err);
        alert('Gagal mengekspor data. Cek console untuk detail.');
      }
    }

    // Export khusus yang belum bayar
    function exportBelumBayarExcel() {
      try {
        if (!kasData || kasData.length === 0) {
          return;
        }

        let csvContent = '\uFEFF';
        csvContent += 'No;Nama;Jumlah Minggu Belum Bayar;Total Harus Bayar (Rp);Catatan\n';

        let adaBelumBayar = false;
        kasData.forEach((anggota, idx) => {
          const nomor = anggota.nomor || (idx + 1);
          const nama = anggota.nama || `Anggota ${idx + 1}`;
          const mingguArr = Array.isArray(anggota.minggu) ? anggota.minggu : Array(totalWeeks).fill(false);
          
          const jumlahMingguBayar = mingguArr.filter(Boolean).length;
          const jumlahMingguBelumBayar = totalWeeks - jumlahMingguBayar;
          const totalHarusBayar = jumlahMingguBelumBayar * PAYMENT_PER_WEEK;
          
          // Hanya export yang belum lunas
          if (jumlahMingguBelumBayar > 0) {
            adaBelumBayar = true;
            const row = [
              nomor,
              nama,
              jumlahMingguBelumBayar,
              totalHarusBayar,
              jumlahMingguBelumBayar === totalWeeks 
                ? 'Belum ada pembayaran sama sekali' 
                : `Masih kurang ${jumlahMingguBelumBayar} minggu`
            ];
            
            csvContent += row.map(cell => {
              if (typeof cell === 'string' && (cell.includes(';') || cell.includes('"'))) {
                return '"' + cell.replace(/"/g, '""') + '"';
              }
              return cell;
            }).join(';') + '\n';
          }
        });

        // Hanya download jika ada yang belum bayar
        if (adaBelumBayar) {
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          
          const today = new Date();
          const dateStr = today.getFullYear() + 
            String(today.getMonth() + 1).padStart(2, '0') + 
            String(today.getDate()).padStart(2, '0');
          
          link.setAttribute('href', url);
          link.setAttribute('download', `Belum_Bayar_Kas_${dateStr}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      } catch (err) {
        console.error('Error export belum bayar:', err);
      }
    }

    // Render Functions
    function renderTransactions() {
      transactionList.innerHTML = '';

      if (!transactions || transactions.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6">Belum ada transaksi.</td>`;
        transactionList.appendChild(tr);
        totalPemasukan.textContent = 'Rp 0';
        totalPengeluaran.textContent = 'Rp 0';
        totalPeminjaman.textContent = 'Rp 0';
        saldoAkhir.textContent = 'Rp 0';
      } else {
        let pemasukan = 0, pengeluaran = 0, peminjaman = 0;
        transactions.forEach(t => {
          const row = document.createElement('tr');
          const jumlahNum = Number(t.jumlah) || 0;
          row.innerHTML = `
            <td>${t.bulan || '-'}</td>
            <td>${t.tanggal || '-'}</td>
            <td>${t.deskripsi || '-'}</td>
            <td>${t.kategori || '-'}</td>
            <td>Rp ${jumlahNum.toLocaleString()}</td>
            <td><button class="delete-btn" data-id="${t.id || ''}">Hapus</button></td>
          `;
          const btn = row.querySelector('.delete-btn');
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (!id) {
              const idx = transactions.indexOf(t);
              if (idx > -1) transactions.splice(idx, 1);
              renderTransactions();
              return;
            }
            if (confirm('Hapus transaksi ini?')) {
              await deleteTransactionById(id);
            }
          });
          transactionList.appendChild(row);

          if (t.kategori === "pemasukan") pemasukan += jumlahNum;
          if (t.kategori === "pengeluaran") pengeluaran += jumlahNum;
          if (t.kategori === "peminjaman") peminjaman += jumlahNum;
        });

        totalPemasukan.textContent = `Rp ${pemasukan.toLocaleString()}`;
        totalPengeluaran.textContent = `Rp ${pengeluaran.toLocaleString()}`;
        totalPeminjaman.textContent = `Rp ${peminjaman.toLocaleString()}`;
        
        // Gunakan saldo akhir berdasarkan urutan transaksi (running balance)
        const saldoAkhirValue = getSaldoAkhirDariTransaksi();
        saldoAkhir.textContent = `Rp ${saldoAkhirValue.toLocaleString()}`;
      }

      // Update saldo uang kas
      const saldoUangKasValue = getSaldoAkhirKas();
      saldoUangKas.textContent = `Rp ${saldoUangKasValue.toLocaleString()}`;

      // Hitung total saldo sekarang (saldo akhir + saldo uang kas)
      const saldoAkhirFinal = getSaldoAkhirDariTransaksi();
      const totalSaldo = saldoAkhirFinal + saldoUangKasValue;
      totalSaldoSekarang.textContent = `Rp ${totalSaldo.toLocaleString()}`;

      renderRekapBulanan();
    }

    async function deleteTransactionById(id) {
      try {
        await hapusTransaksiFirebase(id);
      } catch (err) {
        console.error(err);
        alert('Gagal menghapus transaksi di server. Cek console.');
      }
      const idx = transactions.findIndex(t => t.id === id);
      if (idx > -1) transactions.splice(idx, 1);
      renderTransactions();
    }

    function renderRekapBulanan() {
      const container = document.getElementById('rekap-bulanan');
      container.innerHTML = '';
      let saldo = 0;
      const bulanListFull = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

      bulanListFull.forEach(bulan => {
        const table = document.createElement('table');
        table.style.marginBottom = '10px';
        table.innerHTML = `
          <thead>
            <tr><th colspan="5">${bulan}</th></tr>
            <tr>
              <th>Tanggal</th><th>Deskripsi</th><th>Kategori</th><th>Jumlah (Rp)</th><th>Saldo Akhir</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        const transBulan = transactions.filter(t => t.bulan === bulan).sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

        if (transBulan.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5">Tidak ada transaksi.</td>`;
          tbody.appendChild(tr);
        } else {
          transBulan.forEach(t => {
            const jumlahNum = Number(t.jumlah) || 0;
            if (t.kategori === 'pemasukan') saldo += jumlahNum;
            if (t.kategori === 'pengeluaran') saldo -= jumlahNum;
            if (t.kategori === 'peminjaman') saldo -= jumlahNum;
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${t.tanggal || '-'}</td>
              <td>${t.deskripsi || '-'}</td>
              <td>${t.kategori || '-'}</td>
              <td>Rp ${jumlahNum.toLocaleString()}</td>
              <td>Rp ${saldo.toLocaleString()}</td>
            `;
            tbody.appendChild(row);
          });
        }
        container.appendChild(table);
      });
    }

    function buildKasHeader() {
      let headerRow = '<tr><th>Nama</th>';
      Object.keys(sabtu2025).forEach(b => sabtu2025[b].forEach(tgl => headerRow += `<th>${b} ${tgl}</th>`));
      headerRow += '<th>Total Bayar (Rp)</th></tr>';
      kasHeader.innerHTML = headerRow;
    }

    function renderKas() {
      kasList.innerHTML = '';
      buildKasHeader();

      if (!kasData || kasData.length === 0) {
        defaultKas.forEach((anggota, idx) => {
          const rowElement = document.createElement('tr');
          rowElement.innerHTML = `<td>${anggota.nama}</td>` + anggota.minggu.map(() => `<td><input type="checkbox" disabled></td>`).join('') + `<td>Rp 0</td>`;
          kasList.appendChild(rowElement);
        });
        return;
      }

      kasData.forEach((anggota, idx) => {
        const rowElement = document.createElement('tr');

        // Editable Name Cell
        const namaCell = document.createElement('td');
        namaCell.textContent = anggota.nama || `Anggota ${idx + 1}`;
        namaCell.style.cursor = "pointer";
        namaCell.style.color = "#0066cc";
        namaCell.style.textDecoration = "underline";
        namaCell.addEventListener('click', async () => {
          const namaBaru = prompt("Masukkan nama baru:", anggota.nama);
          if (namaBaru && namaBaru.trim() !== "") {
            anggota.nama = namaBaru.trim();
            if (anggota.id) {
              try {
                await updateNamaKasFirebase(anggota.id, anggota.nama);
              } catch (err) {
                console.error(err);
                alert('Gagal menyimpan nama ke server. Cek console.');
              }
            }
            renderKas();
          }
        });
        rowElement.appendChild(namaCell);

        // Checkbox per minggu
        let total = 0;
        const mingguArr = Array.isArray(anggota.minggu) ? anggota.minggu : Array(totalWeeks).fill(false);
        mingguArr.forEach((paid, mIdx) => {
          const cell = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = !!paid;

          checkbox.addEventListener('change', async (e) => {
            const checked = !!e.target.checked;
            kasData[idx].minggu[mIdx] = checked;
            checkbox.disabled = true;

            try {
              const mingguFix = kasData[idx].minggu.map(v => !!v);
              const nomorVal = kasData[idx].nomor || (idx + 1);
              const namaVal = kasData[idx].nama || `Anggota ${nomorVal}`;
              const totalBayar = mingguFix.filter(Boolean).length * PAYMENT_PER_WEEK;

              if (kasData[idx].id) {
                await updateKasFirebase(kasData[idx].id, mingguFix, namaVal, nomorVal);
              } else {
                const docId = `anggota_${nomorVal}`;
                await setDoc(doc(db, "kas2025", docId), {
                  minggu: mingguFix,
                  nama: namaVal,
                  nomor: nomorVal,
                  totalBayar
                }, { merge: true });
                kasData[idx].id = docId;
              }
            } catch (err) {
              console.error('Gagal simpan checkbox ke server:', err);
              kasData[idx].minggu[mIdx] = !checked;
              checkbox.checked = !checked;
              alert('Gagal menyimpan perubahan. Lihat console untuk error.');
            } finally {
              checkbox.disabled = false;
              renderKas();
            }
          });

          cell.appendChild(checkbox);
          rowElement.appendChild(cell);
          if (paid) total += PAYMENT_PER_WEEK;
        });

        const totalCell = document.createElement('td');
        totalCell.textContent = `Rp ${total.toLocaleString()}`;
        rowElement.appendChild(totalCell);
        kasList.appendChild(rowElement);
      });

      renderRiwayatKas();
      // Update saldo uang kas setelah render kas (renderRiwayatKas sudah update total saldo sekarang)
      const saldoUangKasValue = getSaldoAkhirKas();
      saldoUangKas.textContent = `Rp ${saldoUangKasValue.toLocaleString()}`;
      
      // Pastikan total saldo sekarang juga ter-update
      const saldoAkhirValue = getSaldoAkhirDariTransaksi();
      const totalSaldo = saldoAkhirValue + saldoUangKasValue;
      totalSaldoSekarang.textContent = `Rp ${totalSaldo.toLocaleString()}`;
    }

    kasUsageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const tanggal = document.getElementById('kas-tanggal').value;
      const deskripsi = document.getElementById('kas-deskripsi').value;
      const jumlah = Number(document.getElementById('kas-jumlah').value) || 0;
      const kasBaru = { tanggal, deskripsi, jumlah };
      try {
        const id = await tambahRiwayatKasFirebase(kasBaru);
        kasBaru.id = id;
        kasUsage.unshift(kasBaru);
        kasUsageForm.reset();
        renderRiwayatKas();
      } catch (err) {
        console.error(err);
        alert('Gagal menyimpan riwayat kas. Cek console.');
      }
    });

    function renderRiwayatKas() {
      riwayatKas.innerHTML = '';
      let saldo = getTotalKas();

      const masukRow = document.createElement('tr');
      masukRow.innerHTML = `<td>-</td><td>Masuk</td><td>Total Kas Dibayar</td><td>Rp ${getTotalKas().toLocaleString()}</td><td>Rp ${saldo.toLocaleString()}</td><td></td>`;
      riwayatKas.appendChild(masukRow);

      if (!kasUsage || kasUsage.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6">Belum ada riwayat pemakaian kas.</td>`;
        riwayatKas.appendChild(tr);
        // Update saldo uang kas
        const saldoUangKasValue = getSaldoAkhirKas();
        saldoUangKas.textContent = `Rp ${saldoUangKasValue.toLocaleString()}`;
        // Update total saldo sekarang
        const saldoAkhirValue = getSaldoAkhirDariTransaksi();
        const totalSaldo = saldoAkhirValue + saldoUangKasValue;
        totalSaldoSekarang.textContent = `Rp ${totalSaldo.toLocaleString()}`;
        return;
      }

      kasUsage.forEach((u, idx) => {
        saldo -= u.jumlah;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${u.tanggal || '-'}</td>
          <td>Terpakai</td>
          <td>${u.deskripsi || '-'}</td>
          <td>Rp ${Number(u.jumlah).toLocaleString()}</td>
          <td>Rp ${saldo.toLocaleString()}</td>
          <td><button class="delete-btn" data-id="${u.id || ''}" data-idx="${idx}">Hapus</button></td>
        `;
        const btn = row.querySelector('.delete-btn');
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const index = Number(btn.getAttribute('data-idx'));
          if (id) {
            if (confirm('Hapus riwayat pemakaian kas ini?')) {
              try {
                await hapusRiwayatKasFirebase(id);
                kasUsage.splice(index, 1);
                renderRiwayatKas();
              } catch (err) {
                console.error(err);
                alert('Gagal menghapus dari server. Cek console.');
              }
            }
          } else {
            kasUsage.splice(index, 1);
            renderRiwayatKas();
          }
        });
        riwayatKas.appendChild(row);
      });

      // Update saldo uang kas setelah render riwayat
      const saldoUangKasValue = getSaldoAkhirKas();
      saldoUangKas.textContent = `Rp ${saldoUangKasValue.toLocaleString()}`;
      
      // Update total saldo sekarang
      const saldoAkhirValue = getSaldoAkhirDariTransaksi();
      const totalSaldo = saldoAkhirValue + saldoUangKasValue;
      totalSaldoSekarang.textContent = `Rp ${totalSaldo.toLocaleString()}`;
    }

    transactionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const deskripsi = document.getElementById('deskripsi').value.trim();
      const jumlah = Number(document.getElementById('jumlah').value) || 0;
      const kategori = document.getElementById('kategori').value;
      const bulan = document.getElementById('bulan-transaksi').value;
      const tanggal = document.getElementById('tanggal').value;

      const transaksiBaru = { deskripsi, jumlah, kategori, bulan, tanggal };
      try {
        const id = await tambahTransaksiFirebase(transaksiBaru);
        transaksiBaru.id = id;
        transactions.unshift(transaksiBaru);
        renderTransactions();
        transactionForm.reset();
      } catch (err) {
        console.error(err);
        alert('Gagal menyimpan transaksi. Cek console.');
      }
    });

    // Initialize App
    async function initApp() {
      try {
        const loadedKas = await loadKasFirebase();

        if (loadedKas.length === 0) {
          kasData = defaultKas.map((k, i) => ({
            id: `anggota_${i + 1}`,
            nomor: i + 1,
            nama: `Anggota ${i + 1}`,
            minggu: Array(totalWeeks).fill(false),
            totalBayar: 0
          }));

          for (const k of kasData) {
            await setDoc(doc(db, "kas2025", k.id), k, { merge: true });
          }
        } else {
          kasData = loadedKas.map((k, i) => ({
            ...k,
            nomor: k.nomor || (i + 1),
            minggu: Array.isArray(k.minggu) ? k.minggu.map(v => !!v) : Array(totalWeeks).fill(false),
            totalBayar: typeof k.totalBayar === "number"
              ? k.totalBayar
              : (Array.isArray(k.minggu) ? k.minggu.filter(Boolean).length : 0) * PAYMENT_PER_WEEK
          }));
        }

        transactions = await loadTransaksiFirebase();
        kasUsage = await loadRiwayatKasFirebase();

        renderKas();
        renderTransactions();

        // Add export button event listener after DOM is ready
        const exportBtn = document.getElementById('export-excel-btn');
        if (exportBtn) {
          exportBtn.addEventListener('click', exportToExcel);
        }
      } catch (err) {
        console.error("initApp error:", err);
        alert('Terjadi error saat inisialisasi. Cek console untuk detail.');
      }
    }

    initApp();
  </script>
</body>
</html>
